<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Alicate Domino</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-title" content="Alicate">
    
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTAwIiBzdHlsZT0iYmFja2dyb3VuZC1jb2xvcjogIzAwMDAwMDsiPgogIDwhLS0gR29sZCBSaW5nIC0tPgogIDxjaXJjbGUgY3g9IjUwIiBjeT0iNTAiIHI9IjQ4IiBmaWxsPSIjMDAwMDAwIiBzdHJva2U9IiNmZmQ3MDAiIHN0cm9rZS13aWR0aD0iMyIvPgogIAogIDwhLS0gR3JlZW4gRG9taW5vIChSaWMpIC0tPgogIDxyZWN0IHg9IjMyIiB5PSIzNSIgd2lkdGg9IjIwIiBoZWlnaHQ9IjQwIiB0cmFuc2Zvcm09InJvdGF0ZSgtMzAgNDIgNTUpIiBmaWxsPSIjMzBkMTU4IiByeD0iMiIgc3Ryb2tlPSJ3aGl0ZSIgc3Ryb2tlLXdpZHRoPSIxIi8+CiAgPGNpcmNsZSBjeD0iMzgiIGN5PSI0OCIgcj0iMiIgZmlsbD0id2hpdGUiLz4KICA8Y2lyY2xlIGN4PSI0NiIgY3k9IjUyIiByPSIyIiBmaWxsPSJ3aGl0ZSIvPgogIDxsaW5lIHgxPSIzNCIgeTE9IjUzIiB4Mj0iNTAiIHkyPSI1MyIgc3Ryb2tlPSJibGFjayIgc3Ryb2tlLXdpZHRoPSIxIiB0cmFuc2Zvcm09InJvdGF0ZSgtMzAgNDIgNTUpIi8+CgogIDwhLS0gUmVkIERvbWlubyAoQ2hleWxhKSAtLT4KICA8cmVjdCB4PSI0OCIgeT0iMzUiIHdpZHRoPSIyMCIgaGVpZ2h0PSI0MCIgdHJhbnNmb3JtPSJyb3RhdGUoMzAgNTggNTUpIiBmaWxsPSIjZmY0NTNhIiByeD0iMiIgc3Ryb2tlPSJ3aGl0ZSIgc3Ryb2tlLXdpZHRoPSIxIi8+CiAgPGNpcmNsZSBjeD0iNTQiIGN5PSI1MiIgcj0iMiIgZmlsbD0id2hpdGUiLz4KICA8Y2lyY2xlIGN4PSI2MiIgY3k9IjQ4IiByPSIyIiBmaWxsPSJ3aGl0ZSIvPgogIDxsaW5lIHgxPSI1MCIgeTE9IjUzIiB4Mj0iNjYiIHkyPSI1MyIgc3Ryb2tlPSJibGFjayIgc3Ryb2tlLXdpZHRoPSIxIiB0cmFuc2Zvcm09InJvdGF0ZSgzMCA1OCA1NSkiLz4KCiAgPCEtLSBHb2xkIFN0YXIgLS0+CiAgPHBvbHlnb24gcG9pbnRzPSI1MCwxNSA1NCwyNiA2NiwyNiA1NywzMyA2MCw0NSA1MCwzOSA0MCw0NSA0MywzMyAzNCwyNiA0NiwyNiIgZmlsbD0iI2ZmZDcwMCIvPjwvc3ZnPg==">
    
    <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTAwIiBzdHlsZT0iYmFja2dyb3VuZC1jb2xvcjogIzAwMDAwMDsiPgogIDwhLS0gR29sZCBSaW5nIC0tPgogIDxjaXJjbGUgY3g9IjUwIiBjeT0iNTAiIHI9IjQ4IiBmaWxsPSIjMDAwMDAwIiBzdHJva2U9IiNmZmQ3MDAiIHN0cm9rZS13aWR0aD0iMyIvPgogIAogIDwhLS0gR3JlZW4gRG9taW5vIChSaWMpIC0tPgogIDxyZWN0IHg9IjMyIiB5PSIzNSIgd2lkdGg9IjIwIiBoZWlnaHQ9IjQwIiB0cmFuc2Zvcm09InJvdGF0ZSgtMzAgNDIgNTUpIiBmaWxsPSIjMzBkMTU4IiByeD0iMiIgc3Ryb2tlPSJ3aGl0ZSIgc3Ryb2tlLXdpZHRoPSIxIi8+CiAgPGNpcmNsZSBjeD0iMzgiIGN5PSI0OCIgcj0iMiIgZmlsbD0id2hpdGUiLz4KICA8Y2lyY2xlIGN4PSI0NiIgY3k9IjUyIiByPSIyIiBmaWxsPSJ3aGl0ZSIvPgogIDxsaW5lIHgxPSIzNCIgeTE9IjUzIiB4Mj0iNTAiIHkyPSI1MyIgc3Ryb2tlPSJibGFjayIgc3Ryb2tlLXdpZHRoPSIxIiB0cmFuc2Zvcm09InJvdGF0ZSgtMzAgNDIgNTUpIi8+CgogIDwhLS0gUmVkIERvbWlubyAoQ2hleWxhKSAtLT4KICA8cmVjdCB4PSI0OCIgeT0iMzUiIHdpZHRoPSIyMCIgaGVpZ2h0PSI0MCIgdHJhbnNmb3JtPSJyb3RhdGUoMzAgNTggNTUpIiBmaWxsPSIjZmY0NTNhIiByeD0iMiIgc3Ryb2tlPSJ3aGl0ZSIgc3Ryb2tlLXdpZHRoPSIxIi8+CiAgPGNpcmNsZSBjeD0iNTQiIGN5PSI1MiIgcj0iMiIgZmlsbD0id2hpdGUiLz4KICA8Y2lyY2xlIGN4PSI2MiIgY3k9IjQ4IiByPSIyIiBmaWxsPSJ3aGl0ZSIvPgogIDxsaW5lIHgxPSI1MCIgeTE9IjUzIiB4Mj0iNjYiIHkyPSI1MyIgc3Ryb2tlPSJibGFjayIgc3Ryb2tlLXdpZHRoPSIxIiB0cmFuc2Zvcm09InJvdGF0ZSgzMCA1OCA1NSkiLz4KCiAgPCEtLSBHb2xkIFN0YXIgLS0+CiAgPHBvbHlnb24gcG9pbnRzPSI1MCwxNSA1NCwyNiA2NiwyNiA1NywzMyA2MCw0NSA1MCwzOSA0MCw0NSA0MywzMyAzNCwyNiA0NiwyNiIgZmlsbD0iI2ZmZDcwMCIvPjwvc3ZnPg==">

    <style>
        :root {
            --bg: #000000;
            --card: rgba(28, 28, 30, 0.85); /* Semi-transparent card for background */
            --accent-green: #30d158; /* Player 1 */
            --accent-red: #ff453a;   /* Player 2 */
            --gold: #ffd700;
            --text: #ffffff;
            --border: #38383a;
        }

        /* IOS RESET */
        * { -webkit-tap-highlight-color: transparent; }

        body {
            font-family: -apple-system, system-ui, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 15px;
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
            -webkit-user-select: none;
            user-select: none;
            height: 100vh;
            box-sizing: border-box;
            overflow: hidden;
            
            /* LOGO BACKGROUND */
            background-image: url("data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTAwIiBzdHlsZT0iYmFja2dyb3VuZC1jb2xvcjogdHJhbnNwYXJlbnQ7Ij4KICA8IS0tIEdvbGQgUmluZyAtLT4KICA8Y2lyY2xlIGN4PSI1MCIgY3k9IjUwIiByPSI0OCIgZmlsbD0iIzAwMDAwMCIgc3Ryb2tlPSIjZmZkNzAwIiBzdHJva2Utd2lkdGg9IjMiLz4KICAKICA8IS0tIEdyZWVuIERvbWlubyAoUmljKSAtLT4KICA8cmVjdCB4PSIzMiIgeT0iMzUiIHdpZHRoPSIyMCIgaGVpZ2h0PSI0MCIgdHJhbnNmb3JtPSJyb3RhdGUoLTMwIDQyIDU1KSIgZmlsbD0iIzMwZDE1OCIgcng9IjIiIHN0cm9rZT0id2hpdGUiIHN0cm9rZS13aWR0aD0iMSIvPgogIDxjaXJjbGUgY3g9IjM4IiBjeT0iNDgiIHI9IjIiIGZpbGw9IndoaXRlIi8+CiAgPGNpcmNsZSBjeD0iNDYiIGN5PSI1MiIgcj0iMiIgZmlsbD0id2hpdGUiLz4KICA8bGluZSB4MT0iMzQiIHkxPSI1MyIgeDI9IjUwIiB5Mj0iNTMiIHN0cm9rZT0iYmxhY2siIHN0cm9rZS13aWR0aD0iMSIgdHJhbnNmb3JtPSJyb3RhdGUoLTMwIDQyIDU1KSIvPgoKICA8IS0tIFJlZCBEb21pbm8gKENoZXlsYSkgLS0+CiAgPHJlY3QgeD0iNDgiIHk9IjM1IiB3aWR0aD0iMjAiIGhlaWdodD0iNDAiIHRyYW5zZm9ybT0icm90YXRlKDMwIDU4IDU1KSIgZmlsbD0iI2ZmNDUzYSIgcng9IjIiIHN0cm9rZT0id2hpdGUiIHN0cm9rZS13aWR0aD0iMSIvPgogIDxjaXJjbGUgY3g9IjU0IiBjeT0iNTIiIHI9IjIiIGZpbGw9IndoaXRlIi8+CiAgPGNpcmNsZSBjeD0iNjIiIGN5PSI0OCIgcj0iMiIgZmlsbD0id2hpdGUiLz4KICA8bGluZSB4MT0iNTAiIHkxPSI1MyIgeDI9IjY2IiB5Mj0iNTMiIHN0cm9rZT0iYmxhY2siIHN0cm9rZS13aWR0aD0iMSIgdHJhbnNmb3JtPSJyb3RhdGUoMzAgNTggNTUpIi8+CgogIDwhLS0gR29sZCBTdGFyIC0tPgogIDxwb2x5Z29uIHBvaW50cz0iNTAsMTUgNTQsMjYgNjYsMjYgNTcsMzMgNjAsNDUgNTAsMzkgNDAsNDUgNDMsMzMgMzQsMjYgNDYsMjYiIGZpbGw9IiNmZmQ3MDAiLz48L3N2Zz4=");
            background-repeat: no-repeat;
            background-position: center;
            background-size: 80%; /* Adjust size of background logo */
            position: relative;
        }

        /* DARK OVERLAY FOR BACKGROUND */
        body::before {
            content: "";
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.85); /* Make background dark */
            z-index: -1;
        }

        .container {
            display: flex;
            flex-direction: column;
            gap: 12px;
            max-width: 600px;
            margin: 0 auto;
            height: 100%;
        }

        /* --- LOGO HEADER SECTION --- */
        .logo-area {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-bottom: 5px;
        }
        .logo-icon {
            width: 50px; height: 50px;
            /* Use the embedded SVG */
            background-image: url("data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTAwIiBzdHlsZT0iYmFja2dyb3VuZC1jb2xvcjogdHJhbnNwYXJlbnQ7Ij4KICA8IS0tIEdvbGQgUmluZyAtLT4KICA8Y2lyY2xlIGN4PSI1MCIgY3k9IjUwIiByPSI0OCIgZmlsbD0iIzAwMDAwMCIgc3Ryb2tlPSIjZmZkNzAwIiBzdHJva2Utd2lkdGg9IjMiLz4KICAKICA8IS0tIEdyZWVuIERvbWlubyAoUmljKSAtLT4KICA8cmVjdCB4PSIzMiIgeT0iMzUiIHdpZHRoPSIyMCIgaGVpZ2h0PSI0MCIgdHJhbnNmb3JtPSJyb3RhdGUoLTMwIDQyIDU1KSIgZmlsbD0iIzMwZDE1OCIgcng9IjIiIHN0cm9rZT0id2hpdGUiIHN0cm9rZS13aWR0aD0iMSIvPgogIDxjaXJjbGUgY3g9IjM4IiBjeT0iNDgiIHI9IjIiIGZpbGw9IndoaXRlIi8+CiAgPGNpcmNsZSBjeD0iNDYiIGN5PSI1MiIgcj0iMiIgZmlsbD0id2hpdGUiLz4KICA8bGluZSB4MT0iMzQiIHkxPSI1MyIgeDI9IjUwIiB5Mj0iNTMiIHN0cm9rZT0iYmxhY2siIHN0cm9rZS13aWR0aD0iMSIgdHJhbnNmb3JtPSJyb3RhdGUoLTMwIDQyIDU1KSIvPgoKICA8IS0tIFJlZCBEb21pbm8gKENoZXlsYSkgLS0+CiAgPHJlY3QgeD0iNDgiIHk9IjM1IiB3aWR0aD0iMjAiIGhlaWdodD0iNDAiIHRyYW5zZm9ybT0icm90YXRlKDMwIDU4IDU1KSIgZmlsbD0iI2ZmNDUzYSIgcng9IjIiIHN0cm9rZT0id2hpdGUiIHN0cm9rZS13aWR0aD0iMSIvPgogIDxjaXJjbGUgY3g9IjU0IiBjeT0iNTIiIHI9IjIiIGZpbGw9IndoaXRlIi8+CiAgPGNpcmNsZSBjeD0iNjIiIGN5PSI0OCIgcj0iMiIgZmlsbD0id2hpdGUiLz4KICA8bGluZSB4MT0iNTAiIHkxPSI1MyIgeDI9IjY2IiB5Mj0iNTMiIHN0cm9rZT0iYmxhY2siIHN0cm9rZS13aWR0aD0iMSIgdHJhbnNmb3JtPSJyb3RhdGUoMzAgNTggNTUpIi8+CgogIDwhLS0gR29sZCBTdGFyIC0tPgogIDxwb2x5Z29uIHBvaW50cz0iNTAsMTUgNTQsMjYgNjYsMjYgNTcsMzMgNjAsNDUgNTAsMzkgNDAsNDUgNDMsMzMgMzQsMjYgNDYsMjYiIGZpbGw9IiNmZmQ3MDAiLz48L3N2Zz4=");
            background-size: contain;
            background-repeat: no-repeat;
        }
        .logo-text {
            color: var(--gold);
            font-size: 1.8rem;
            font-weight: 900;
            letter-spacing: 2px;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.3);
            text-transform: uppercase;
        }

        /* TOP BAR */
        .top-row { display: flex; justify-content: space-between; align-items: center; min-height: 30px; flex-shrink: 0; }
        .recent-history { display: flex; gap: 5px; overflow-x: auto; flex: 1; margin-right: 10px; }
        .history-tag { 
            background: #2c2c2e; padding: 4px 8px; border-radius: 6px; 
            font-size: 0.7rem; color: var(--gold); border: 1px solid #444; 
            white-space: nowrap; font-weight: bold;
        }
        
        .top-buttons { display: flex; gap: 8px; }
        .btn-top { 
            background: #1c1c1e; color: #fff; border: 1px solid #555; 
            padding: 6px 12px; border-radius: 20px; font-size: 0.75rem; 
            cursor: pointer; white-space: nowrap;
        }

        /* NAMES */
        .header-names { display: flex; gap: 10px; flex-shrink: 0; }
        .name-input { 
            background: rgba(255,255,255,0.08); border: 1px dashed #444; color: white; 
            padding: 10px; border-radius: 8px; width: 100%; text-align: center; 
            font-size: 1.1rem; font-weight: 700;
        }

        /* SCOREBOARD */
        .scoreboard {
            background: var(--card);
            border-radius: 16px;
            padding: 10px 15px;
            display: flex;
            justify-content: space-around;
            align-items: center;
            border: 1px solid #333;
            position: relative;
            flex-shrink: 0;
        }
        .score-box { text-align: center; flex: 1; transition: transform 0.2s; }
        .score-value { font-family: 'Courier New', monospace; font-size: 3rem; font-weight: 900; line-height: 1; transition: color 0.3s; }
        .win-stars { 
            color: var(--gold); font-size: 1.2rem; margin-top: 5px; 
            min-height: 1.4rem; letter-spacing: 5px; text-shadow: 0 0 10px rgba(255, 215, 0, 0.4);
        }

        /* ANIMATION */
        @keyframes goldPulse {
            0% { transform: scale(1); text-shadow: 0 0 0 rgba(255, 215, 0, 0); }
            50% { transform: scale(1.15); text-shadow: 0 0 30px var(--gold); color: var(--gold); }
            100% { transform: scale(1); text-shadow: 0 0 0 rgba(255, 215, 0, 0); }
        }
        .winner-anim { animation: goldPulse 0.8s ease-in-out; }

        /* CONTROLS */
        .controls {
            display: flex;
            flex-direction: column;
            gap: 10px;
            background: var(--card);
            padding: 15px;
            border-radius: 16px;
            border: 1px solid var(--border);
            flex-shrink: 0; 
        }

        .input-row { display: flex; gap: 10px; }
        #pointInput {
            width: 100%;
            background: #000;
            border: 2px solid #444;
            color: var(--gold);
            font-size: 1.8rem;
            text-align: center;
            padding: 8px;
            border-radius: 10px;
            font-weight: bold;
            -moz-appearance: textfield; 
        }
        #pointInput::-webkit-outer-spin-button,
        #pointInput::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        #pointInput:focus { border-color: var(--gold); outline: none; }

        .btn-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }

        button.game-btn { 
            padding: 12px; border: none; border-radius: 10px; 
            font-size: 0.8rem; font-weight: bold; color: white; 
            cursor: pointer; position: relative; z-index: 1;
        }
        button.game-btn:active { transform: scale(0.97); opacity: 0.9; background-color: #444; }
        button.locked { opacity: 0.5; pointer-events: none; }

        .btn-green { background-color: var(--accent-green); color: #000; }
        .btn-red { background-color: var(--accent-red); }
        .btn-blue { background-color: #0a84ff; }
        .btn-gold { background: linear-gradient(135deg, #ffd700, #b8860b); color: black; box-shadow: 0 4px 15px rgba(255, 215, 0, 0.2); }
        .btn-utility { background: #333; color: #bbb; font-size: 0.7rem; }

        /* HISTORY TABLE */
        .history-section {
            background: var(--card); /* Using card color for table bg now */
            border-radius: 8px;
            border: 1px solid var(--border);
            flex: 1; 
            overflow-y: auto; 
            -webkit-overflow-scrolling: touch;
        }
        table { width: 100%; border-collapse: collapse; }
        th { 
            background: #2c2c2e; font-size: 0.7rem; padding: 10px; 
            border-bottom: 1px solid var(--border); color: #8e8e93; 
            text-transform: uppercase; letter-spacing: 1px;
            position: sticky; top: 0; z-index: 10;
        }
        td { 
            padding: 8px; text-align: center; border-bottom: 1px solid #333; 
            font-size: 1.1rem; font-weight: 600; 
        }
        .pts-a { color: var(--accent-green); }
        .pts-b { color: var(--accent-red); }
        .round-col { color: #555; font-size: 0.9rem; }

        .limit-label {
            text-align: center; color: #666; font-size: 0.65rem; 
            font-weight: bold; margin-top: -5px; letter-spacing: 1px;
        }
    </style>
</head>
<body>

<div class="container">
    
    <div class="logo-area">
        <div class="logo-icon"></div>
        <div class="logo-text">ALICATE</div>
    </div>

    <div class="top-row">
        <div class="recent-history" id="recentWins"></div>
        <div class="top-buttons">
            <button class="btn-top" onclick="toggleBestOf()" id="btnBestOf">Best of 5</button>
            <button class="btn-top" onclick="toggleLang()" id="langBtn">Espa√±ol</button>
        </div>
    </div>
    
    <div class="header-names">
        <input class="name-input" id="nameA" value="Ric" placeholder="Name 1">
        <input class="name-input" id="nameB" value="Cheyla" placeholder="Name 2">
    </div>

    <div class="scoreboard">
        <div class="score-box">
            <div id="valA" class="score-value" style="color:var(--accent-green)">00</div>
            <div id="starsA" class="win-stars"></div>
        </div>
        <div style="text-align:center">
            <div style="color: #444; font-size: 0.9rem; font-weight: bold;">VS</div>
        </div>
        <div class="score-box">
            <div id="valB" class="score-value" style="color:var(--accent-red)">00</div>
            <div id="starsB" class="win-stars"></div>
        </div>
    </div>
    <div class="limit-label">LIMIT: 200</div>

    <div class="controls">
        <div class="input-row">
            <input type="number" id="pointInput" placeholder="0" pattern="\d*" inputmode="numeric">
        </div>
        <div class="btn-grid">
            <button class="game-btn btn-green" id="btnAddA" onclick="submitManualPoints('A')">Add to Ric</button>
            <button class="game-btn btn-red" id="btnAddB" onclick="submitManualPoints('B')">Add to Cheyla</button>
        </div>
        <div class="btn-grid">
            <button class="game-btn btn-blue" id="btnQuickA" onclick="addPoints('A', 25)">+25 Ric</button>
            <button class="game-btn btn-blue" id="btnQuickB" onclick="addPoints('B', 25)">+25 Cheyla</button>
            <button class="game-btn btn-gold" id="btnCapA" onclick="addPoints('A', 25)">CAPIC√öA Ric</button>
            <button class="game-btn btn-gold" id="btnCapB" onclick="addPoints('B', 25)">CAPIC√öA Cheyla</button>
            <button class="game-btn btn-utility" onclick="undoLast()">UNDO</button>
            <button class="game-btn btn-utility" id="btnReset" onclick="fullReset()">RESET ALL</button>
        </div>
    </div>

    <div class="history-section" id="scrollArea">
        <table>
            <thead>
                <tr>
                    <th id="lblMano">Round</th>
                    <th id="tableHeadA">Ric</th>
                    <th id="tableHeadB">Cheyla</th>
                </tr>
            </thead>
            <tbody id="historyBody"></tbody>
        </table>
    </div>
    
    <div style="text-align: center; margin-top: 10px;">
        <a href="#" onclick="emergencyClear()" style="color: #bbb; font-size: 10px; text-decoration: none;">Hard Reset</a>
    </div>
</div>

<script>
    // --- ROBUST INITIALIZATION ---
    let lang = 'EN';
    let bestOf = 5; 
    let tournament = { scoreA: 0, scoreB: 0, gamesA: 0, gamesB: 0, rounds: [] };
    let winHistory = [];
    let isProcessingWin = false; 

    function safeLoad() {
        try {
            const savedHistory = localStorage.getItem('dominoWinHistory');
            if (savedHistory) winHistory = JSON.parse(savedHistory);
            
            const savedBestOf = localStorage.getItem('dominoBestOf');
            if (savedBestOf) bestOf = parseInt(savedBestOf);
            
            const savedNameA = localStorage.getItem('dominoNameA');
            const savedNameB = localStorage.getItem('dominoNameB');
            if (savedNameA) document.getElementById('nameA').value = savedNameA;
            if (savedNameB) document.getElementById('nameB').value = savedNameB;
        } catch (e) {
            console.error("Data corrupt, resetting");
            localStorage.clear();
        }
    }

    window.emergencyClear = function() {
        if(confirm("Factory Reset? This deletes all data.")) {
            localStorage.clear();
            location.reload();
        }
    };

    const texts = {
        EN: { 
            btn: "Espa√±ol", mano: "Round", cap: "CAPIC√öA", add: "Add to", 
            reset: "RESET TOURNAMENT", winMsg: "wins the game!", 
            champMsg: "TOURNAMENT CHAMPIONS:", quick: "+25 ", bestOf: "Best of"
        },
        ES: { 
            btn: "English", mano: "Mano", cap: "CAPIC√öA", add: "Sumar a", 
            reset: "REINICIAR TORNEO", winMsg: "gan√≥ el juego!", 
            champMsg: "CAMPEONES:", quick: "+25 ", bestOf: "Mejor de"
        }
    };

    // --- CORE LOGIC ---

    window.toggleLang = function() {
        lang = lang === 'EN' ? 'ES' : 'EN';
        updateLabels();
    };

    window.toggleBestOf = function() {
        if (bestOf === 3) bestOf = 5;
        else if (bestOf === 5) bestOf = 7;
        else bestOf = 3;
        localStorage.setItem('dominoBestOf', bestOf);
        updateLabels();
    };

    function updateLabels() {
        const t = texts[lang];
        document.getElementById('langBtn').innerText = t.btn;
        document.getElementById('lblMano').innerText = t.mano;
        document.getElementById('btnReset').innerText = t.reset;
        document.getElementById('btnBestOf').innerText = `${t.bestOf} ${bestOf}`;
        syncNames();
    }

    function syncNames() {
        const nA = document.getElementById('nameA').value;
        const nB = document.getElementById('nameB').value;
        const t = texts[lang];
        
        localStorage.setItem('dominoNameA', nA);
        localStorage.setItem('dominoNameB', nB);

        document.getElementById('tableHeadA').innerText = nA;
        document.getElementById('tableHeadB').innerText = nB;
        document.getElementById('btnAddA').innerText = `${t.add} ${nA}`;
        document.getElementById('btnAddB').innerText = `${t.add} ${nB}`;
        document.getElementById('btnQuickA').innerText = t.quick + nA;
        document.getElementById('btnQuickB').innerText = t.quick + nB;
        document.getElementById('btnCapA').innerText = t.cap + " " + nA;
        document.getElementById('btnCapB').innerText = t.cap + " " + nB;
    }

    window.submitManualPoints = function(team) {
        const input = document.getElementById('pointInput');
        const val = parseInt(input.value);
        if (!isNaN(val) && val > 0) {
            addPoints(team, val);
            input.value = ""; 
            input.focus();    
        }
    };

    window.addPoints = function(team, pts) {
        if (isProcessingWin) return; 

        if (team === 'A') tournament.scoreA += pts;
        else tournament.scoreB += pts;
        
        tournament.rounds.push({ team, pts });
        updateUI(); 
        
        if (tournament.scoreA >= 200 || tournament.scoreB >= 200) {
            triggerWinSequence(team);
        }
    };

    function triggerWinSequence(team) {
        isProcessingWin = true; 
        lockControls(true);

        if (tournament.scoreA >= 200) tournament.gamesA++;
        else tournament.gamesB++;

        updateUI();

        const winningValId = tournament.scoreA >= 200 ? 'valA' : 'valB';
        const winningElement = document.getElementById(winningValId);
        if(winningElement) winningElement.classList.add('winner-anim');

        setTimeout(() => {
            let winnerName = tournament.scoreA >= 200 ? document.getElementById('nameA').value : document.getElementById('nameB').value;
            alert("üéâ " + winnerName + " " + texts[lang].winMsg);
            
            if(winningElement) winningElement.classList.remove('winner-anim');
            tournament.scoreA = 0; 
            tournament.scoreB = 0; 
            tournament.rounds = [];
            
            updateUI(); 
            isProcessingWin = false; 
            lockControls(false);

            const winsNeeded = Math.ceil(bestOf / 2);
            if (tournament.gamesA >= winsNeeded || tournament.gamesB >= winsNeeded) {
                setTimeout(() => {
                    alert("üèÜüèÜüèÜ " + texts[lang].champMsg + " " + winnerName + " üèÜüèÜüèÜ");
                    winHistory.push(winnerName);
                    localStorage.setItem('dominoWinHistory', JSON.stringify(winHistory));
                    fullReset(true);
                }, 300);
            }
        }, 800);
    }

    window.undoLast = function() {
        if (isProcessingWin) return;
        if (tournament.rounds.length === 0) return;
        const last = tournament.rounds.pop();
        if (last.team === 'A') tournament.scoreA -= last.pts;
        else tournament.scoreB -= last.pts;
        updateUI();
    };

    function updateUI() {
        document.getElementById('valA').innerText = tournament.scoreA.toString().padStart(2, '0');
        document.getElementById('valB').innerText = tournament.scoreB.toString().padStart(2, '0');
        
        document.getElementById('starsA').innerText = "‚≠ê".repeat(tournament.gamesA);
        document.getElementById('starsB').innerText = "‚≠ê".repeat(tournament.gamesB);
        
        document.getElementById('historyBody').innerHTML = tournament.rounds.map((r, i) => 
            `<tr>
                <td class="round-col">${i+1}</td>
                <td class="pts-a">${r.team==='A'?'+'+r.pts:'-'}</td>
                <td class="pts-b">${r.team==='B'?'+'+r.pts:'-'}</td>
            </tr>`
        ).join('');
        
        const scrollArea = document.getElementById('scrollArea');
        if(scrollArea) scrollArea.scrollTop = scrollArea.scrollHeight;

        renderWinHistory();
    }

    function renderWinHistory() {
        const el = document.getElementById('recentWins');
        if(el) {
            el.innerHTML = winHistory.slice(-5).reverse().map(win => 
                `<div class="history-tag">üèÜ ${win}</div>`
            ).join('');
        }
    }

    function lockControls(locked) {
        const btns = document.querySelectorAll('button.game-btn');
        btns.forEach(b => {
            if (locked) b.classList.add('locked');
            else b.classList.remove('locked');
        });
    }

    window.fullReset = function(silent = false) {
        if (silent || confirm("Reset entire tournament? / ¬øReiniciar torneo?")) {
            tournament.scoreA = 0; tournament.scoreB = 0; tournament.rounds = [];
            if (!silent) { tournament.gamesA = 0; tournament.gamesB = 0; }
            updateUI();
        }
    };

    // --- STARTUP ---
    window.onload = function() {
        safeLoad();
        
        const nA = document.getElementById('nameA');
        const nB = document.getElementById('nameB');
        
        if(nA && nB) {
            ['input', 'keyup', 'change'].forEach(evt => {
                nA.addEventListener(evt, syncNames);
                nB.addEventListener(evt, syncNames);
            });
        }

        updateLabels();
        renderWinHistory();
    };
</script>
</body>
</html>